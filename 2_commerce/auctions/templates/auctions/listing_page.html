{% extends 'auctions/layout.html' %}

{% block body %}
    <h2 class="page-title">Listing: {{ listing.title }}</h1>
    {% if not listing.is_open %}
        <p>This listing is closed</p>
    {% endif %}

    {% if user == listing.creator and listing.is_open %}
        <a href="{% url 'close' listing.id %}">[Close Listing]</a>
    {% endif %}        
    <p><b>Description:</b> {{ listing.description|safe }} </p>
    <p><b>Minimum Bid:</b> US$ {{ listing.minimum_bid }}</p>
    <p><b>Image URL:</b> {{ listing.image_url }}</p>
    <p><b>Creator:</b> {{ listing.creator }}</p>
    <p><b>Category:</b> {{ listing.category }}</p>
    
    {% if current_bid and listing.is_open %}
        <p><b>Current Bid:</b> US$ {{ current_bid.value }}</p>
        <p><b>Current winner:</b> {{ current_bid.user }}</p>
    {% elif listing.is_open %}
        <p>Be the first to place a bid!</p>
    {% elif current_bid %}
        <p><b>Listing winner:</b> {{ current_bid.user }} </p>
        <p><b>Winning bid:</b> {{ current_bid.value }} </p>
    {% endif %}

    {% if user.is_authenticated and listing.is_open %}
        <p>Place Bid (your bid should be greater than the inicial value and the current bid)</p>
        <form action="{% url 'listing' listing.id %}" method=POST>
            {% csrf_token %}
            {% if bid_error %}
                <p>Your bid should be greater than the current bid!</p>
            {% endif %}
            <input type="number" value="{{ min_bid }}" step="any" name="bid">
            <input type="submit" value="Bid!">
        </form>
        {% if listing in user.watchlist.all %}
            <p><a href="{% url 'toggle_watchlist' listing.id %}">[Remove from watchlist]</a></p>
        {% else %}
            <p><a href="{% url 'toggle_watchlist' listing.id %}">[Add to watchlist]</a></p>
        {% endif %}
    {% endif %}

    {% if not listing.is_open and current_bid.user == user %}
        <p>Parabéns, você é o vencedor!</p>
    {% endif %}

    <img src={{listing.image_url}}>
    <h3>Comment section</h3>
    {% for comment in comments %}
        <p><b>{{ comment.user }}:</b> {{ comment.text }}</p>
    {% endfor %}
    {% if user.is_authenticated and listing.is_open%}
        <form action="{% url 'listing' listing.id %}" method="POST">
            {% csrf_token %}
            <textarea name='text' placeholder="Comment here..." required=""></textarea>
            <input type="submit" value="Submit">
        </form>
    {% endif %}


{% endblock %}